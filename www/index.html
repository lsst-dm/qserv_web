<!DOCTYPE html>
<html lang="en">

<head>

<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.css">

<title>Qserv Replication System</title>

<style>
#status {
padding:1em;
}
table#level pre, table#workers pre {
padding:0;
margin:0;
}
table#level td, table#workers td {
vertical-align:middle;
</style>

</head>

<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
  <a class="navbar-brand" href="#" >Qserv [PDAC]</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav mr-auto nav" role="tablist">
      <li class="nav-item">
        <a class="nav-link active"
           id="tab-status"
           data-toggle="tab"
           href="#status"
           role="tab"
           aria-controls="status"
           aria-selected="true"
           >Status <span class="sr-only">(current)</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link"
           id="tab-replication"
           data-toggle="tab"
           href="#replication"
           role="tab"
           aria-controls="replication"
           aria-selected="false"
           >Replication</a>
      </li>
      <li class="nav-item">
        <a class="nav-link"
           id="tab-ingest"
           data-toggle="tab"
           href="#ingest"
           role="tab"
           aria-controls="ingest"
           aria-selected="false"
           >Ingest</a>
      </li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle "
           href="#"
           id="navbarDropdown"
           role="button"
           data-toggle="dropdown"
           aria-haspopup="true"
           aria-expanded="false">Admin</a>
        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
          <a class="dropdown-item"
             id="tab-settings"
             data-toggle="tab"
             href="#settings"
             role="tab"
             aria-controls="settings"
             aria-selected="false">Settings</a>
          <div class="dropdown-divider"></div>
          <a class="dropdown-item"
             id="tab-security"
             data-toggle="tab"
             href="#security"
             role="tab"
             aria-controls="security"
             aria-selected="false">Accounts and security</a>
        </div>
      </li>
    </ul>
    <form class="form-inline my-2 my-lg-0">
      <input class="form-control mr-sm-2 form-control-sm" type="search" placeholder="chunk" aria-label="Search"/>
      <button class="btn btn-outline-light my-2 my-sm-0 btn-sm" type="submit">Search</button>
    </form>
  </div>
</nav>
<div class="tab-content" id="nav-tabContent">
  <div class="tab-pane fade show active"
       id="status"
       role="tabpanel"
       aria-labelledby="tab-status">

    <ul class="nav nav-pills mb-0" id="status-tab" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" id="status-replevel-tab" data-toggle="pill"
           href="#status-replevel" role="tab"
           aria-controls="status-replevel" aria-selected="true">Replication Level</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="status-workers-tab" data-toggle="pill"
           href="#status-workers" role="tab"
           aria-controls="status-workers" aria-selected="false">Workers</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="status-queries-tab" data-toggle="pill"
           href="#status-queries" role="tab"
           aria-controls="status-queries" aria-selected="false">User Queries</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="status-hitmap-tab" data-toggle="pill"
           href="#status-hitmap" role="tab"
           aria-controls="status-hitmap" aria-selected="false">Heat Map</a>
      </li>
    </ul>
    <div class="tab-content" id="status-tabContent">

      <div class="tab-pane  fade show active" id="status-replevel"
           role="tabpanel" aria-labelledby="status-replevel-tab">

        <div class="container-fluid" style="padding-top:1em;">
          <div class="row">
            <div class="col-md-4">
              <p>This dynamically updated table shows the <span style="font-weight:bold;">Act</span>ual replication
                levels for chunks across all known <span style="font-weight:bold;">Database</span>s.
                These levels may also be below or above the <span style="font-weight:bold;">Req</span>uired
                level which is set for each database <span style="font-weight:bold;">Family</span> in
                a configuration of the system. The levels may change for some chunks depending on
                a number of worker nodes which are <span style="font-weight:bold;">On-line</span> or
                <span style="font-weight:bold;">Inactive</span> (not responding) at a time when this
                table gets updated.
              </p>
              <p>Numbers under the
                <span style="font-weight:bold;">&plus;&nbsp;Inactive</span> columns
                represent a speculative scenario of <span style="font-style:italic;">what the
                replication level would be if</span> those nodes would also be
                <span style="font-weight:bold;">On-line</span> based on the last successful
                replica disposition scan of those nodes.
              </p>
              <p><span style="font-weight:bold;">HINT:</span> there seems to be a significant
                redundancy in the <span style="font-weight:bold;">Act</span>ual number of
                replicas well above the minimally <span style="font-weight:bold;">Req</span>uired
                level. Consider running the replica <span style="font-weight:bold;">Purge</span>
                tool.
              </p>
              <p><span style="font-weight:bold;">TODO:</span></p>
              <ul>
                <li>add a hyperlink to the Configuration section within this application</li>
                <li>add a hyperlink to the Workers tab to show a status of he workers</li>
                <li>add a hyperlink the replica <span style="font-weight:bold;">Purge</span> tool</li>
              </ul>
            </div>
            <div class="col-md-8">
              <table class="table table-sm table-hover table-bordered" id="level">
                <caption style="caption-side:top; text-align:right; padding-top:0;">
                  Loading...
                </caption>
                <thead class="thead-light">
                  <tr>
                    <th rowspan="3" style="vertical-align:middle">Family</th>
                    <th rowspan="3" style="vertical-align:middle">Req.</th>
                    <th rowspan="3" style="vertical-align:middle">Database</th>
                    <th rowspan="3" style="vertical-align:middle; text-align:right; border-right-color:#A9A9A9">Act.</th>
                    <th colspan="4" style="text-align:right; border-right-color:#A9A9A9">Qserv</th>
                    <th colspan="4" style="text-align:right">Replication Sys.</th>
                  </tr>
                    <th colspan="2" style="text-align:right">On-line</th>
                    <th colspan="2" style="text-align:right; border-right-color:#A9A9A9">&plus;&nbsp;Inactive</th>
                    <th colspan="2" style="text-align:right">On-line</th>
                    <th colspan="2" style="text-align:right">&plus;&nbsp;Inactive</th>
                  </tr>
                  <tr>
                    <th style="text-align:right">#chunks</th>
                    <th style="text-align:right">%</th>
                    <th style="text-align:right">#chunks</th>
                    <th style="text-align:right; border-right-color:#A9A9A9">%</th>
                    <th style="text-align:right">#chunks</th>
                    <th style="text-align:right">%</th>
                    <th style="text-align:right">#chunks</th>
                    <th style="text-align:right">%</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="status-workers"
           role="tabpanel" aria-labelledby="status-workers-tab">

        <div class="container-fluid" style="padding-top:1em;">
          <div class="row">
            <div class="col-md-4">
              <p>This dynamically updated table shows the status of <span style="font-weight:bold;">Worker</span>
                services in each category. A <span style="font-weight:bold;">Qserv</span> worker
                is supposed to be <span style="font-weight:bold;">OFF-LINE</span> if no response is
                received from the worker during the most recent <span style="font-weight:bold;">Health Monitoring probe</span>.
                In that case a non-zero value (the number of seconds) would be show in column
                <span style="font-weight:bold;">Last Response</span>.
                The state of the <span style="font-weight:bold;">Replication System</span>'s workers
                is a bit more complex. Workers in this category can be in one of the following
                states: <span style="font-weight:bold;">ENABLED</span>,
                <span style="font-weight:bold;">READ-ONLY</span>, or <span style="font-weight:bold;">DISABLED</span>.
                Note that the <span style="font-weight:bold;">Last Response</span> tracking for this type of
                workers is done in the first two categories only.
                Regardless of a status (or a response delay) of a worker, a number shown in the
                <span style="font-weight:bold;">#replicas</span> column will indicate either the actual number
                of replicas on the corresponding node, or the latest recorded number obtained from the last recorded scan
                of the worker node made by the <span style="font-weight:bold;">Replication System</span> before
                the worker service became non-responsive.
              </p>
            </div>
            <div class="col-md-8">

              <table class="table table-sm table-hover table-bordered" id="workers">
                <caption style="caption-side:top; text-align:right;">
                  Loading...
                </caption>
                <thead class="thead-light">
                  <tr>
                    <th rowspan="2" style="vertical-align:middle;">Worker</th>
                    <th rowspan="2" style="vertical-align:middle; text-align:right;">#replicas</th>
                    <th colspan="2" style="text-align:right">Qserv</th>
                    <th colspan="2" style="text-align:right">Replication Sys.</th>
                  </tr>
                  <tr>
                    <th style="text-align:right">Status</th>
                    <th style="text-align:right">Last Response [s]</th>
                    <th style="text-align:right">Status</th>
                    <th style="text-align:right">Last Response [s]</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="status-queries"
           role="tabpanel" aria-labelledby="status-queries-tab">
        (TBC) The on-going and most recent user queries launched in Qserv...
      </div>
      <div class="tab-pane fade" id="status-hitmap"
           role="tabpanel" aria-labelledby="status-hitmap-tab">
        2-D map of chunks which are in use by Qserv.
        Use colors to represent multiple uses of the same chunk (chunks with the same
        number which belong to different databases).
        <span style="text-weight:bold;">ATTENTION:</span> Different database families
        would have different maps.
      </div>

    </div>
  </div>
  <div class="tab-pane fade"
       id="replication"
       role="tabpanel"
       aria-labelledby="tab-replication">
    <div class="container-fluid">
      Here be UI for monitoring and launching replication operations. And also, for managing
      the Master Replication Controller and Worker Services. All of this will be arranged into
      tabs or menus.
    </div>
  </div>
  <div class="tab-pane fade"
       id="ingest"
       role="tabpanel"
       aria-labelledby="tab-ingest">
    <div class="container-fluid">
      Here be UI for setting up and managing new catalog ingest operations.
      An extra layer of tabs or menus will be added if needed.
    </div>
  </div>
  <div class="tab-pane fade"
       id="settings"
       role="tabpanel"
       aria-labelledby="tab-settings">
    <div class="container-fluid">
      Settings, defaults, automatic notifications (by e-mail, etc.)
    </div>
  </div>
  <div class="tab-pane fade"
       id="security"
       role="tabpanel"
       aria-labelledby="tab-security">
    <div class="container-fluid">
      Accounts and Security: who can do what and in which scope.
    </div>
  </div>
</div>
    
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.js"></script>
<script src="https://underscorejs.org/underscore-min.js"></script>

<!-- Application logic -->
<script src="main.js"></script>

<script>

$(function() {
    main();
});
</script>

</body>
</html>